<?
if(!class_exists('bancos')) require 'bancos.php';//CASO EXISTA EU DESVIO A CLASSE ...
class calculos {
    /*Observaзгo muito importante: quando o "$id_negociacao_item" й diferente de Zero entгo o sistema faz o cбlculo 
    de todos os Impostos p/ o Item especнfico da Negociaзгo, do contrбrio se for passado igual a Zero o sistema 
    faz o cбlculo de todos os Impostos de todos os Itens da Negociaзгo ...

    ** Na maioria dos casos o $id_produto й um $id_produto_acabado, exceto p/ NFC que й um $id_produto_insumo ...
    ** Esse 4є parвmetro $id_nfe_debitar sу й utilizado p/ NFC ...*/

    //Essa funзгo retorna o Valor de Imposto por Item ou de todos os Itens ...
    function calculo_impostos($id_negociacao_item, $id_negociacao, $tipo_negociacao = '', $id_nfe_debitar = 0) {
        if(!class_exists('genericas'))      require 'genericas.php';//CASO EXISTA EU DESVIO A CLASSE ...
        if(!class_exists('intermodular'))   require 'intermodular.php';//CASO EXISTA EU DESVIO A CLASSE ...

        $valor_total_nota_us    = 0;//Essa variбvel sу serб abastecida quando for pelo caminho NF de Saнda e Estrangeira ...
        $ipi_incluso            = 'N';//Essa variбvel sу serб abastecida quando for pelo caminho NF de Entrada "Compras" ...
        /**********************************************Orзamento**********************************************/
        if($tipo_negociacao == 'OV') {//Orзamento de Vendas ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            $sql = "SELECT c.`id_pais`, c.`id_uf`, c.`insc_estadual`, c.`tipo_suframa`, c.`suframa_ativo`, c.`tributar_ipi_rev`, 
                    c.`optante_simples_nacional`, c.`isento_st`, ov.`id_cliente`, ov.`finalidade`, 
                    ov.`valor_frete_estimado`, ov.`artigo_isencao`, ov.`nota_sgd`, ov.`data_emissao` 
                    FROM `orcamentos_vendas` ov 
                    INNER JOIN `clientes` c ON c.`id_cliente` = ov.`id_cliente` 
                    WHERE ov.`id_orcamento_venda` = '$id_negociacao' LIMIT 1 ";
            $campos                     = bancos::sql($sql);
            $id_pais                    = $campos[0]['id_pais'];
            $id_uf_cliente              = $campos[0]['id_uf'];
            $insc_estadual              = $campos[0]['insc_estadual'];
            $suframa                    = $campos[0]['tipo_suframa'];
            $suframa_ativo              = $campos[0]['suframa_ativo'];
            $tributar_ipi_rev		= $campos[0]['tributar_ipi_rev'];
            $optante_simples_nacional   = $campos[0]['optante_simples_nacional'];
            $isento_st                  = $campos[0]['isento_st'];
            $id_cliente                 = $campos[0]['id_cliente'];
            //Nгo existe o campo id_empresa na parte de Orзamento, sendo assim faзo essa adaptaзгo ...
            $id_empresa_negociacao      = ($campos[0]['nota_sgd'] == 'S') ? 4 : 1;
            $finalidade                 = $campos[0]['finalidade'];
            $artigo_isencao 		= $campos[0]['artigo_isencao'];
            $nota_sgd                   = $campos[0]['nota_sgd'];
            $valor_frete                = $campos[0]['valor_frete_estimado'];
            $outras_despesas_acessorias = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_cfop                    = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_comp                 = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_outra_comp           = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $data_emissao               = $campos[0]['data_emissao'];
            $texto_nf                   = '';//Nessa Situaзгo nгo existe essa variбvel ...
            
            if(!empty($id_negociacao_item)) $condicao = " AND ovi.`id_orcamento_venda_item` = '$id_negociacao_item' LIMIT 1 ";

            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT SUM(ovi.`qtde` * pa.`peso_unitario`) AS peso_lote_total_kg 
                    FROM `orcamentos_vendas_itens` ovi 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = ovi.`id_produto_acabado` 
                    WHERE ovi.`id_orcamento_venda` = '$id_negociacao' ";
            $campos_lote                = bancos::sql($sql);
            $peso_lote_total_kg 	= round($campos_lote[0]['peso_lote_total_kg'], 4);
            
            //A operaзгo de Fat. do PA sempre serб Industrial quando o Cliente possuir a marcaзгo de Tributar IPI REV e for daqui do Brasil ...
            //Aqui eu busco detalhes especнfico do Item ...
            $sql = "SELECT ovi.`id_produto_acabado`, ovi.`id_produto_acabado_discriminacao`, ovi.`qtde`, ovi.`preco_liq_final` AS preco_unitario, 
                    ovi.`iva`, pa.`origem_mercadoria`, pa.`peso_unitario` 
                    FROM `orcamentos_vendas_itens` ovi 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = ovi.`id_produto_acabado` 
                    WHERE ovi.`id_orcamento_venda` = '$id_negociacao' $condicao ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        /**********************************************Pedido**********************************************/
        }else if($tipo_negociacao == 'PV') {//Pedido de Vendas ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            $sql = "SELECT c.`id_pais`, c.`id_uf`, c.`insc_estadual`, c.`tipo_suframa`, c.`suframa_ativo`, c.`tributar_ipi_rev`, 
                    c.`optante_simples_nacional`, c.`isento_st`, pv.`id_cliente`, pv.`id_empresa`, 
                    pv.`finalidade`, pv.`data_emissao` 
                    FROM `pedidos_vendas` pv 
                    INNER JOIN `clientes` c ON c.`id_cliente` = pv.`id_cliente` 
                    WHERE pv.`id_pedido_venda` = '$id_negociacao' LIMIT 1 ";
            $campos                     = bancos::sql($sql);
            $id_pais                    = $campos[0]['id_pais'];
            $id_uf_cliente              = $campos[0]['id_uf'];
            $insc_estadual              = $campos[0]['insc_estadual'];
            $suframa                    = $campos[0]['tipo_suframa'];
            $suframa_ativo              = $campos[0]['suframa_ativo'];
            $tributar_ipi_rev           = $campos[0]['tributar_ipi_rev'];
            $optante_simples_nacional   = $campos[0]['optante_simples_nacional'];
            $isento_st                  = $campos[0]['isento_st'];
            $id_cliente                 = $campos[0]['id_cliente'];
            $id_empresa_negociacao      = $campos[0]['id_empresa'];
            $finalidade                 = $campos[0]['finalidade'];
            $nota_sgd                   = ($campos[0]['id_empresa'] == 4) ? 'S' : 'N';
            $valor_frete                = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $outras_despesas_acessorias = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_cfop                    = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_comp                 = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_outra_comp           = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $data_emissao               = $campos[0]['data_emissao'];
            $texto_nf                   = '';//Nessa Situaзгo nгo existe essa variбvel ...
            
            //Busca do Artigo Isenзгo do Orзamento ...
            $sql = "SELECT ov.`artigo_isencao` 
                    FROM `pedidos_vendas_itens` pvi 
                    INNER JOIN `orcamentos_vendas_itens` ovi ON ovi.`id_orcamento_venda_item` = pvi.`id_orcamento_venda_item` 
                    INNER JOIN `orcamentos_vendas` ov ON ov.`id_orcamento_venda` = ovi.`id_orcamento_venda` 
                    WHERE pvi.`id_pedido_venda` = '$id_negociacao' LIMIT 1 ";
            $campos_artigo_isencao	= bancos::sql($sql);
            $artigo_isencao 		= $campos_artigo_isencao[0]['artigo_isencao'];
            
            if(!empty($id_negociacao_item)) $condicao = " AND pvi.`id_pedido_venda_item` = '$id_negociacao_item' LIMIT 1 ";

            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT SUM(pvi.`qtde` * pa.`peso_unitario`) AS peso_lote_total_kg 
                    FROM `pedidos_vendas_itens` pvi 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = pvi.`id_produto_acabado` 
                    WHERE pvi.`id_pedido_venda` = '$id_negociacao' ";
            $campos_lote                = bancos::sql($sql);
            $peso_lote_total_kg 	= round($campos_lote[0]['peso_lote_total_kg'], 4);

            //A operaзгo de Fat. do PA sempre serб Industrial quando o Cliente possuir a marcaзгo de Tributar IPI REV e for daqui do Brasil ...
            //Aqui eu busco detalhes especнfico do Item ...
            $sql = "SELECT pvi.`id_produto_acabado`, pvi.`qtde`, pvi.`preco_liq_final` AS preco_unitario, 
                    ovi.`id_produto_acabado_discriminacao`, ovi.`iva`, pa.`origem_mercadoria`, pa.`peso_unitario` 
                    FROM `pedidos_vendas_itens` pvi 
                    INNER JOIN `orcamentos_vendas_itens` ovi ON ovi.`id_orcamento_venda_item` = pvi.`id_orcamento_venda_item` 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = ovi.`id_produto_acabado` 
                    WHERE pvi.`id_pedido_venda` = '$id_negociacao' $condicao ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        /**********************************************Nota Fiscal**********************************************/	
        }else if($tipo_negociacao == 'NF') {//NF de Saнda ou NF de Devoluзгo - Setor de Faturamento ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            $sql = "SELECT c.`id_pais`, c.`id_uf`, c.`insc_estadual`, c.`tipo_suframa`, c.`suframa_ativo`, c.`tributar_ipi_rev`, 
                    c.`optante_simples_nacional`, c.`isento_st`, nfs.`id_cliente`, nfs.`id_empresa`, nfs.`finalidade`, nfs.`despesas_acessorias`, 
                    nfs.`valor_frete`, nfs.`data_emissao`, nfs.`ajuste_valor_icms`, nfs.`ajuste_base_calc_icms_st`, nfs.`ajuste_valor_icms_st`, 
                    nfs.`texto_nf` 
                    FROM `nfs` 
                    INNER JOIN `clientes` c ON c.id_cliente = nfs.id_cliente 
                    WHERE nfs.`id_nf` = '$id_negociacao' LIMIT 1 ";
            $campos                     = bancos::sql($sql);
            $id_pais                    = $campos[0]['id_pais'];
            $id_uf_cliente              = $campos[0]['id_uf'];
            $insc_estadual              = $campos[0]['insc_estadual'];
            $suframa                    = $campos[0]['tipo_suframa'];
            $suframa_ativo              = $campos[0]['suframa_ativo'];
            $tributar_ipi_rev           = $campos[0]['tributar_ipi_rev'];
            $optante_simples_nacional   = $campos[0]['optante_simples_nacional'];
            $isento_st                  = $campos[0]['isento_st'];
            $id_cliente                 = $campos[0]['id_cliente'];
            $id_empresa_negociacao      = $campos[0]['id_empresa'];
            $id_cfop                    = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_comp                 = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_outra_comp           = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $finalidade                 = $campos[0]['finalidade'];
            
            $vetor_nota_sgd             = genericas::nota_sgd($id_empresa_negociacao);
            $nota_sgd                   = $vetor_nota_sgd['nota_sgd'];

            $outras_despesas_acessorias = $campos[0]['despesas_acessorias'];
            $valor_frete                = $campos[0]['valor_frete'];
            $data_emissao               = $campos[0]['data_emissao'];
            $ajuste_valor_icms          = $campos[0]['ajuste_valor_icms'];
            $ajuste_base_calc_icms_st   = $campos[0]['ajuste_base_calc_icms_st'];
            $ajuste_valor_icms_st       = $campos[0]['ajuste_valor_icms_st'];
            $texto_nf                   = $campos[0]['texto_nf'];
            
            //Busca do Artigo Isenзгo do Orзamento ...
            $sql = "SELECT ov.`artigo_isencao` 
                    FROM `nfs_itens` nfsi 
                    INNER JOIN `pedidos_vendas_itens` pvi ON pvi.`id_pedido_venda_item` = nfsi.`id_pedido_venda_item` 
                    INNER JOIN `orcamentos_vendas_itens` ovi ON ovi.`id_orcamento_venda_item` = pvi.`id_orcamento_venda_item` 
                    INNER JOIN `orcamentos_vendas` ov ON ov.`id_orcamento_venda` = ovi.`id_orcamento_venda` 
                    WHERE nfsi.`id_nf` = '$id_negociacao' LIMIT 1 ";
            $campos_artigo_isencao	= bancos::sql($sql);
            $artigo_isencao 		= $campos_artigo_isencao[0]['artigo_isencao'];
            
            if(!empty($id_negociacao_item)) $condicao = " AND nfsi.`id_nfs_item` = '$id_negociacao_item' LIMIT 1 ";

            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT IF(nfs.`status` = '6', SUM(nfsi.`qtde_devolvida` * pa.`peso_unitario`), SUM(nfsi.`qtde` * pa.`peso_unitario`)) AS peso_lote_total_kg 
                    FROM `nfs_itens` nfsi 
                    INNER JOIN `nfs` ON nfs.`id_nf` = nfsi.`id_nf` 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = nfsi.`id_produto_acabado` 
                    WHERE nfsi.`id_nf` = '$id_negociacao' ";
            $campos_lote                = bancos::sql($sql);
            $peso_lote_total_kg 	= round($campos_lote[0]['peso_lote_total_kg'], 4);
            
            /******************************************************************/
            /*************************Paнs Estrangeiro*************************/
            /******************************************************************/
            /*Se o paнs for Estrangeiro, entгo retorno esse Valor Total da Nota Fiscal em U$ porque o mesmo й 
            utilizado na tela de Itens da Nota Fiscal e nas Duplicatas do Financeiro ...*/
            if($id_pais != 31) {
                //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
                $sql = "SELECT SUM(`qtde` * `valor_unitario_exp`) AS valor_total_nota_us 
                        FROM `nfs_itens` 
                        WHERE `id_nf` = '$id_negociacao' ";
                $campos_total_nota_us   = bancos::sql($sql);
                $valor_total_nota_us    = $campos_total_nota_us[0]['valor_total_nota_us'];
            }
            /******************************************************************/

            //A operaзгo de Fat. do PA sempre serб Industrial quando o Cliente possuir a marcaзгo de Tributar IPI REV e for daqui do Brasil ...
            //Aqui eu busco detalhes especнfico do Item ...
            $sql = "SELECT nfsi.`id_produto_acabado`, IF(nfs.`status` = 6, nfsi.`qtde_devolvida`, nfsi.`qtde`) AS qtde, 
                    nfsi.`valor_unitario` AS preco_unitario, nfsi.`icms`, nfsi.`ipi`, nfsi.`reducao`, 
                    nfsi.`icms_intraestadual`, nfsi.`iva`, ovi.`id_produto_acabado_discriminacao`, pa.`origem_mercadoria`, pa.`peso_unitario` 
                    FROM `nfs_itens` nfsi 
                    INNER JOIN `pedidos_vendas_itens` pvi ON pvi.`id_pedido_venda_item` = nfsi.`id_pedido_venda_item` 
                    INNER JOIN `orcamentos_vendas_itens` ovi ON ovi.`id_orcamento_venda_item` = pvi.`id_orcamento_venda_item` 
                    INNER JOIN `nfs` ON nfs.`id_nf` = nfsi.`id_nf` 
                    INNER JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = nfsi.`id_produto_acabado` 
                    WHERE nfsi.`id_nf` = '$id_negociacao' $condicao ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        /**********************************************Nota Fiscal Outra**********************************************/
        }else if($tipo_negociacao == 'NFO') {//NF Outras - Setor de Faturamento ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            $sql = "SELECT c.`id_pais`, c.`id_uf`, c.`insc_estadual`, c.`tipo_suframa`, c.`suframa_ativo`, 
                    c.`tributar_ipi_rev`, c.`optante_simples_nacional`, c.`isento_st`, 
                    nfso.`id_cliente`, nfso.`id_empresa`, nfso.`id_cfop`, 
                    nfso.`id_nf_comp`, nfso.`id_nf_outra_comp`, nfso.`finalidade`, 
                    IF(nfso.`id_empresa` = 4, 'S', 'N') AS nota_sgd, 
                    nfso.`valor_frete`, nfso.`ajuste_total_produtos`, nfso.`ajuste_total_nf`, 
                    nfso.`ajuste_ipi`, nfso.`ajuste_icms`, nfso.`data_emissao`, nfso.`texto_nf`, 
                    nfso.`base_calculo_icms_comp`, nfso.`valor_icms_comp`, 
                    nfso.`base_calculo_icms_st_comp`, nfso.`valor_icms_st_comp`, 
                    nfso.`valor_total_produtos_comp`, nfso.`valor_frete_comp`, 
                    nfso.`valor_seguro_comp`, nfso.`outras_despesas_acessorias_comp`, 
                    nfso.`valor_ipi_comp`, nfso.`valor_total_nota_comp` 
                    FROM `nfs_outras` nfso 
                    INNER JOIN `clientes` c ON c.`id_cliente` = nfso.`id_cliente` 
                    WHERE nfso.`id_nf_outra` = '$id_negociacao' LIMIT 1 ";
            $campos                     = bancos::sql($sql);
            $id_pais                    = $campos[0]['id_pais'];
            $id_uf_cliente              = $campos[0]['id_uf'];
            $insc_estadual              = $campos[0]['insc_estadual'];
            $suframa                    = $campos[0]['tipo_suframa'];
            $suframa_ativo              = $campos[0]['suframa_ativo'];
            $optante_simples_nacional   = $campos[0]['optante_simples_nacional'];
            $isento_st                  = $campos[0]['isento_st'];
            $id_cliente                 = $campos[0]['id_cliente'];
            $id_empresa_negociacao      = $campos[0]['id_empresa'];

            /*Se a Empresa da Nota Fiscal for 'K2', entгo eu sempre assumo que esse campo 
            "$tributar_ipi_rev" do Cliente estб marcado, p/ que as OF(s) do PA sempre saiam 
            como Industrial ...*/
            $tributar_ipi_rev           = ($id_empresa_negociacao == 3) ? 'S' : $campos[0]['tributar_ipi_rev'];

            $id_cfop                    = $campos[0]['id_cfop'];
            $id_nf_comp                 = $campos[0]['id_nf_comp'];
            $id_nf_outra_comp           = $campos[0]['id_nf_outra_comp'];
            $finalidade                 = $campos[0]['finalidade'];
            $nota_sgd                   = $campos[0]['nota_sgd'];
            $outras_despesas_acessorias = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $valor_frete                = $campos[0]['valor_frete'];
            $ajuste_total_produtos      = $campos[0]['ajuste_total_produtos'];
            $ajuste_total_nf            = $campos[0]['ajuste_total_nf'];
            $ajuste_ipi                 = $campos[0]['ajuste_ipi'];
            $ajuste_icms                = $campos[0]['ajuste_icms'];
            $data_emissao               = $campos[0]['data_emissao'];
            $texto_nf                   = $campos[0]['texto_nf'];
            
            if(!empty($id_negociacao_item)) $condicao = " AND nfsoi.`id_nf_outra_item` = '$id_negociacao_item' LIMIT 1 ";

            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT SUM(qtde * peso_unitario) AS peso_lote_total_kg 
                    FROM `nfs_outras_itens` 
                    WHERE `id_nf_outra` = '$id_negociacao' ";
            $campos_lote                = bancos::sql($sql);
            $peso_lote_total_kg 	= round($campos_lote[0]['peso_lote_total_kg'], 4);

            //A operaзгo de Fat. do PA sempre serб Industrial quando o Cliente possuir a marcaзгo de Tributar IPI REV e for daqui do Brasil ...
            //Aqui eu busco detalhes especнfico do Item ...
            $sql = "SELECT nfsoi.`id_produto_acabado`, nfsoi.`qtde`, nfsoi.`valor_unitario` AS preco_unitario, 
                    nfsoi.`ipi`, nfsoi.`icms`, nfsoi.`reducao`, nfsoi.`icms_intraestadual`, nfsoi.`iva`, 
                    nfsoi.`peso_unitario`, nfsoi.`imposto_importacao`, nfsoi.`valor_cif`, 
                    nfsoi.`bc_icms_item`, nfsoi.`pis`, nfsoi.`cofins`, nfsoi.`despesas_aduaneiras`, 
                    nfsoi.`despesas_acessorias`, IF('$tributar_ipi_rev' = 'S', 0, pa.`operacao`) AS operacao, 
                    pa.`origem_mercadoria`, pa.`peso_unitario` 
                    FROM `nfs_outras_itens` nfsoi 
                    LEFT JOIN `produtos_acabados` pa ON pa.`id_produto_acabado` = nfsoi.`id_produto_acabado` 
                    WHERE nfsoi.`id_nf_outra` = '$id_negociacao' $condicao ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        /**********************************************Nota Fiscal Compras**********************************************/
        }else if($tipo_negociacao == 'NFC') {//NF de Compras "Entrada" - Setor de Compras ...
            //Aqui eu busco dados do Tipo de Negociaзгo ...
            $sql = "SELECT f.`id_uf`, f.`id_pais`, f.`optante_simples_nacional`, nfe.`id_fornecedor`, 
                    nfe.`finalidade`, IF(nfe.`tipo` = '1', 'N', 'S') AS nota_sgd, 
                    SUBSTRING(nfe.`data_emissao`, 1, 10) AS data_emissao 
                    FROM `nfe` 
                    INNER JOIN `fornecedores` f ON f.`id_fornecedor` = nfe.`id_fornecedor` 
                    WHERE nfe.`id_nfe` = '$id_negociacao' LIMIT 1 ";
            $campos                     = bancos::sql($sql);
            $id_uf_fornecedor           = $campos[0]['id_uf'];
            $id_pais                    = $campos[0]['id_pais'];
            $optante_simples_nacional   = $campos[0]['optante_simples_nacional'];
            $isento_st                  = 'N';//Nessa Situaзгo nгo existe essa variбvel ...
            $finalidade                 = $campos[0]['finalidade'];
            $nota_sgd                   = $campos[0]['nota_sgd'];
            $data_emissao               = $campos[0]['data_emissao'];
            
            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT SUM(nfeh.`qtde_entregue` * pi.`peso`) AS peso_lote_total_kg 
                    FROM `nfe_historicos` nfeh 
                    INNER JOIN `produtos_insumos` pi ON pi.`id_produto_insumo` = nfeh.`id_produto_insumo` 
                    WHERE nfeh.`id_nfe` = '$id_negociacao' ";
            $campos_lote                = bancos::sql($sql);
            $peso_lote_total_kg 	= round($campos_lote[0]['peso_lote_total_kg'], 4);
            
            if(!empty($id_negociacao_item)) $condicao = " AND `id_nfe_historico` = '$id_negociacao_item' LIMIT 1 ";
/*Esse parвmetro "$id_nfe_debitar" traz da Nota Fiscal passada por parвmetro, itens que foram atrelados a esta 
e esses itens estгo vinculados а algum N.є de Nota Fiscal ...
 

Exemplo Real: 

Temos uma Nota Fiscal Principal do Fornecedor "ESPACIAL" 273133 que tem 11 itens:
 
    *** 2 desses itens serгo debitados para K2 onde cada um desses tem um N.є de Nota Fiscal diferente ...
    *** O primeiro й da Nota Fiscal Fiscal "273133" da K2 ...
    *** O segundo й da Nota Fiscal Fiscal "4217" da K2 ...

Se dentro do sistema estamos acessando a Nota Fiscal "273133" da K2, por mais que o sistema perceba que a Nota Fiscal 
do Fornecedor "ESPACIAL" й correlata e exiba a mesma na Tela de itens, o Financiamento que fica dentro do Cabeзalho 
sу serб calculado p/ "K2" na Nota Fiscal "273133" em cima da Nota Fiscal Principal "ESPACIAL" em que os itens 
dessa Nota Fiscal tenham a marcaзгo de debitados com o mesmo N.є "273133" da K2 ...*/
            if($id_nfe_debitar > 0) $condicao_itens = " AND `id_nfe_debitar` = '$id_nfe_debitar' ";

            //Aqui eu busco detalhes especнfico do Item, obs: nгo existe IPI p/ id_empresa = '4' que й "Grupo" ...
            $sql = "SELECT nfeh.`id_produto_insumo`, nfeh.`cod_tipo_ajuste`, nfeh.`qtde_entregue` AS qtde, 
                    nfeh.`valor_entregue` AS preco_unitario, 
                    IF(nfe.`id_empresa` = 4, '0', nfeh.`ipi_entregue`) AS ipi, nfeh.`ipi_incluso`, 
                    nfeh.`icms_entregue` AS icms, nfeh.`reducao`, nfeh.`iva` 
                    FROM `nfe_historicos` nfeh 
                    INNER JOIN `nfe` ON nfe.`id_nfe` = nfeh.`id_nfe` 
                    WHERE nfeh.`id_nfe` = '$id_negociacao' $condicao $condicao_itens ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        }else if($tipo_negociacao == 'SN') {//Sem Negociaзгo, nesse caso nгo existe e sendo assim faзo uma atribuiзгo manual p/ as variбveis ...
            $id_pais                    = 31;//Brasil ...
            $id_uf_cliente              = 1;//Estado de Sгo Paulo
            $tributar_ipi_rev		= 'N';//Nessa Situaзгo nгo existe essa variбvel ...
            $optante_simples_nacional   = 'N';//Nessa Situaзгo nгo existe essa variбvel ...
            $isento_st                  = 'N';//Nessa Situaзгo nгo existe essa variбvel ...
            $suframa                    = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $suframa_ativo              = 'N';//Nessa Situaзгo nгo existe essa variбvel ...
            $finalidade                 = 'R';
            $artigo_isencao 		= 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $nota_sgd                   = 'N';
            $valor_frete                = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $outras_despesas_acessorias = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_cfop                    = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_comp                 = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $id_nf_outra_comp           = 0;//Nessa Situaзгo nгo existe essa variбvel ...
            $data_emissao               = date('Y-m-d');
            $texto_nf                   = '';//Nessa Situaзгo nгo existe essa variбvel ...
            
            //Busca o Peso do Lote de Todos os Itens em Kg p/ utilizar mais abaixo para fazer os cбlculos ...
            $sql = "SELECT `peso_unitario` AS peso_lote_total_kg 
                    FROM `produtos_acabados` 
                    WHERE `id_produto_acabado` = '$id_negociacao_item' ";
            $campos_lote        = bancos::sql($sql);
            $peso_lote_total_kg = round($campos_lote[0]['peso_lote_total_kg'], 4);
            
            //A operaзгo de Fat. do PA sempre serб Industrial independente de possuir a marcaзгo de Tributar IPI REV ...
            //Aqui eu busco detalhes especнfico do Item ...
            $sql = "SELECT `id_produto_acabado`, `origem_mercadoria`, `peso_unitario` 
                    FROM `produtos_acabados` 
                    WHERE `id_produto_acabado` = '$id_negociacao_item' ";
            $campos_itens   = bancos::sql($sql);
            $linhas_itens   = count($campos_itens);
        }
/***********************************************************************************************************/
/**********************************************NF Complementar**********************************************/
/***********************************************************************************************************/
/*Significa que foi feito uma NF Complementar e sendo assim й sу eu retornar os campos complementares que jб 
foram gravados na NF anteriormente ...*/ 
        if($id_nf_comp > 0 || $id_nf_outra_comp > 0) {
            $base_calculo_icms                  = $campos[0]['base_calculo_icms_comp'];
            $valor_icms                         = $campos[0]['valor_icms_comp'];
            $base_calculo_icms_st               = $campos[0]['base_calculo_icms_st_comp'];
            $valor_icms_st                      = $campos[0]['valor_icms_st_comp'];
            $valor_total_produtos               = $campos[0]['valor_total_produtos_comp'];
            $valor_frete                        = $campos[0]['valor_frete_comp'];
            $outras_despesas_acessorias         = $campos[0]['outras_despesas_acessorias_comp'];
            $valor_ipi                          = $campos[0]['valor_ipi_comp'];
            $valor_total_nota                   = $campos[0]['valor_total_nota_comp'];
        }else {//Foi feito qualquer outro Tipo de NF ...
/****************************************************************************************************/
/***********************Procedimento genйrico independente das situaзхes acima***********************/
/****************************************************************************************************/
            if($nota_sgd == 'N' && $id_cfop != 0) {//Se a Empresa for Alba ou Tool e existir CFOP ...
                $sql = "SELECT CONCAT(cfop, '.', num_cfop) AS cfop, natureza_operacao_resumida 
                        FROM `cfops` 
                        WHERE `id_cfop` = '$id_cfop' LIMIT 1 ";
                $campos_cfop        = bancos::sql($sql);
                $cfop               = $campos_cfop[0]['cfop'];
                $natureza_operacao  = $campos_cfop[0]['natureza_operacao_resumida'];
            }
/************************************************************************************************************/
/********************************** CFOP 3.101 - Compra p/ Industrializaзгo *********************************/
/************************************************************************************************************/
            //Somente nessas CFOP que os cбlculos sгo totalmente diferenciados ...
            if($cfop == '3.101' || $cfop == '3.102') {
                for($i = 0; $i < $linhas_itens; $i++) {
                    $base_calculo_icms+=    $campos_itens[$i]['bc_icms_item'];
                    $pis+=                  $campos_itens[$i]['pis'];
                    $cofins+=               $campos_itens[$i]['cofins'];
                    $despesas_aduaneiras+=  $campos_itens[$i]['despesas_aduaneiras'];
                    $outras_despesas_acessorias+= $campos_itens[$i]['despesas_acessorias'];

                    $icms_item_current_rs   = round(($campos_itens[$i]['bc_icms_item'] * $campos_itens[$i]['icms'] / 100) * ((100 - $campos_itens[$i]['reducao']) / 100), 2);
                    $valor_icms+=           $icms_item_current_rs;

                    $ii_item_current_rs     = round($campos_itens[$i]['valor_cif'] * $campos_itens[$i]['imposto_importacao'] / 100, 2);
                    
                    $ipi_item_current_rs    = round((($campos_itens[$i]['valor_cif'] + $ii_item_current_rs) * $campos_itens[$i]['ipi'] / 100), 2);
                    $total_ipi_itens_rs+=   $ipi_item_current_rs;

                    $valor_total            = round($ii_item_current_rs + $campos_itens[$i]['valor_cif'], 2);
                    $valor_total_produtos+= $valor_total;
                    
                    $valor_total_mais_impostos  = round($valor_total + $icms_item_current_rs + $ipi_item_current_rs, 2);
                    $valor_total_nota+= $valor_total_mais_impostos;
                }
                $valor_total_produtos+= $ajuste_total_produtos;
                $valor_ipi              = $total_ipi_itens_rs + $ajuste_ipi;
                $valor_icms+=           $ajuste_icms;
                
                $valor_total_nota+=     $valor_frete + $outras_despesas_acessorias + $ajuste_total_nf + $pis + $cofins + $despesas_aduaneiras;
/************************************************************************************************************/
/******************************************** Qualquer outra CFOP *******************************************/
/************************************************************************************************************/
            }else {
                for($i = 0; $i < $linhas_itens; $i++) {
                    /*Esse controle й de extrema importвncia porque em casos de "Gato por Lebre", preciso pegar os impostos do Gato ...

                    Ex: o cliente comprou MRH-042 "Gato", mas estamos enviando o MRT-042 "Lebre ou substituto" ...*/
                    $id_produto_acabado_utilizar = (!empty($campos_itens[$i]['id_produto_acabado_discriminacao'])) ? $campos_itens[$i]['id_produto_acabado_discriminacao'] : $campos_itens[$i]['id_produto_acabado'];
                    
                    if($tipo_negociacao == 'OV' || $tipo_negociacao == 'PV' || $tipo_negociacao == 'SN') {//Essas sгo as 3 ъnicas situaзхes que nгo gravamos os impostos na tabela de Itens ...
                        $dados_produto 		= intermodular::dados_impostos_pa($id_produto_acabado_utilizar, $id_uf_cliente, $id_cliente, $id_empresa_negociacao, $finalidade);
                        $id_classific_fiscal    = $dados_produto['id_classific_fiscal'];
                        $ipi                    = $dados_produto['ipi'];
                        $icms                   = $dados_produto['icms'];
                        $reducao                = $dados_produto['reducao'];
                        $icms_intraestadual     = $dados_produto['icms_intraestadual'];
                        $fecp                   = $dados_produto['fecp'];
                        
                        //No orзamento e no Pedido, nуs gravamos essa variбvel ...
                        if($tipo_negociacao == 'OV' || $tipo_negociacao == 'PV') {
                            $iva                = $campos_itens[$i]['iva'];
                        }else {
                            $iva                = $dados_produto['iva'];
                        }
                    }else {
                        $dados_produto 		= intermodular::dados_impostos_pa($id_produto_acabado_utilizar, $id_uf_cliente, $id_cliente, $id_empresa_negociacao, $finalidade);
                        $id_classific_fiscal    = $dados_produto['id_classific_fiscal'];
                        $ipi                    = $campos_itens[$i]['ipi'];
                        $ipi_incluso            = $campos_itens[$i]['ipi_incluso'];//Esse campo sу existe p/ NF de Entrada "Compras" ...
                        $icms                   = $campos_itens[$i]['icms'];
                        $reducao                = $campos_itens[$i]['reducao'];
                        $icms_intraestadual     = $campos_itens[$i]['icms_intraestadual'];
                        $fecp                   = $dados_produto['fecp'];
                        $iva                    = $campos_itens[$i]['iva'];
                    }
                    /**************************************************************************************************/
                    /*Esse tratamento estб sendo feito por causa do Tipo de Negociaзгo = 'SN' que й Sem Negociaзгo, 
                    somente nesse caso que essas variбveis serгo nulas e faзo isso p/ nгo dar erro mais abaixo 
                    c/ o desenrolar dos cбlculos ...*/
                    $qtde           = (!empty($campos_itens[$i]['qtde'])) ? $campos_itens[$i]['qtde'] : 1;
                    $preco_unitario = (!empty($campos_itens[$i]['preco_unitario'])) ? $campos_itens[$i]['preco_unitario'] : 100;
                    /**************************************************************************************************/
                    
                    //Cбlculos genйricos independente das situaзхes acima ...
                    $valor_total                = round($qtde * $preco_unitario, 2);
                    //Aqui eu tenho o Peso do Lote de Todos em Kg do ъnico item em especнfico ...
                    $peso_lote_item_current_kg  = $qtde * $campos_itens[$i]['peso_unitario'];

                    /*Cбlculo p/ achar o "Frete + Desp. Acessуrias" do Item corrente, em cima do "Frete Total em R$ + 
                    Despesas Acessуrias em R$", achar o "Frete Individual + Despesas Acessуrias Individual", 
                    achar a sua fatia dentro do Total ...*/
                    $frete_despesas_acessorias_item_current_rs = (($valor_frete + $outras_despesas_acessorias) * $peso_lote_item_current_kg);

                    //P/ evitar erro de Divisгo por zero, sу existe a Divisгo se > 0
                    if($peso_lote_total_kg > 0) $frete_despesas_acessorias_item_current_rs/= $peso_lote_total_kg;
                    
                    /***********************************************************************************************/
                    /*****************************************Cбlculo de IPI****************************************/
                    /***********************************************************************************************/
                    if($ipi_incluso == 'S') {//Somente na NF de Compras "Entrada" que existirб esse campo ...
                        $ipi_incluso_item_current_rs = round(($ipi / 100) * $valor_total, 2);//Cбlculo o Valor do IPI em R$ ...
                        $total_ipi_incluso_itens_rs+= $ipi_incluso_item_current_rs;
                        $ipi_frete_despesas_acessorias_item_current_rs  = 0;
                    }else {
                        if($ipi == '0.00') {//Se nгo existir IPI para o Item corrente ...
                            $ipi_item_current_rs                            = 0;
                            $ipi_frete_despesas_acessorias_item_current_rs  = 0;
                        }else {//Existe algum IPI ...
                            $ipi_item_current_rs = round(($ipi / 100) * $valor_total, 2);//Cбlculo o Valor do IPI em R$ ...
                            $total_ipi_itens_rs+= $ipi_item_current_rs;
                            $ipi_frete_despesas_acessorias_item_current_rs  = ($ipi / 100) * $frete_despesas_acessorias_item_current_rs;
                        }
                    }
                    
                    //Acumula o Total de todos os IPI(s) Frete Desp Acessуrias em R$ ...
                    $ipi_frete_desp_aces_todos_itens+= $ipi_frete_despesas_acessorias_item_current_rs;

                    if($icms == '0.00') {//Se nгo existir ICMS para o Item corrente ...
                        $icms_frete_despesas_acessorias_item_current_rs = 0;
                    }else {
                        //Quando for CONSUMO, tem de somar o Valor de IPI do Frete do Item no cбlculo do Icms do Frete ...
                        if($finalidade == 'C') {
                            $icms_frete_despesas_acessorias_item_current_rs = (($frete_despesas_acessorias_item_current_rs + $ipi_frete_despesas_acessorias_item_current_rs) * ($icms / 100));
                        }else {//Do contrбrio nгo precisa ...
                            $icms_frete_despesas_acessorias_item_current_rs = (($frete_despesas_acessorias_item_current_rs) * ($icms / 100));
                        }
                        //Obs: Se existir reduзгo, entгo eu preciso aplicar estб no ICMS do Frete + DA do Item ...
                        if($reducao != '0.00') $icms_frete_despesas_acessorias_item_current_rs*= (100 - $reducao) / 100;
                    }

                    //Acumula o Total de todos os ICMS(s) Frete Desp Acessуrias em R$ ...
                    $icms_frete_desp_aces_todos_itens+= $icms_frete_despesas_acessorias_item_current_rs;

                    /*Criei essa variбvel de 'ipi_ST' pois preciso desse valor para os cбlculos de ST + abaixo. Lembrando que as variбveis de IPI sгo zeradas 
                    por causa das Bases de Cбlculo ...*/
                    $ipi_item_current_para_st_rs = $ipi_item_current_rs + $ipi_frete_despesas_acessorias_item_current_rs + $frete_despesas_acessorias_item_current_rs;
                    
                    //Essa variбvel serб utilizada somente no "TXT" de nossas notas fiscais Eletrфnicas ...
                    $ipi_frete_despesas_acessorias_txt = $ipi_frete_despesas_acessorias_item_current_rs;

                    /*Verifico a Finalidade da Nota Fiscal - sempre que a NF for "REVENDA" ou "INDUSTRIALIZAЗГO" 
                    eu zero o valor dessas variбveis que foi calculado anteriormente, porque irб influenciar 
                    nos resultados de bases de cбlculo ...

                    Revenda ou Industrializaзгo nгo caracteriza fato gerador de IPI ...*/
                    if($finalidade == 'R' || $finalidade == 'I') {
                        $ipi_item_current_rs                            = 0;
                        $ipi_frete_despesas_acessorias_item_current_rs  = 0;
                    }
                    $valor_total_produtos+= $valor_total;

                    $dados_produto              = intermodular::dados_impostos_pa($id_produto_acabado_utilizar, $id_uf_cliente, $id_cliente, $id_empresa_negociacao, $finalidade);
                    $operacao                   = $dados_produto['operacao'];
                    $situacao_tributaria        = $dados_produto['situacao_tributaria'];
                    $desconto_pis_cofins_icms   = $dados_produto['desconto_pis_cofins_icms'];

                    if($reducao != '0.00') {//Quando o item tiver Reduзгo B. C.
                        /**********Cуdigo Adaptado no dia 11/02/2014 - Dбrcio
                        Sempre que a Situaзгo do PA vs UF for = 60 'ICMS cobrado anteriormente por substituiзгo 
                        tributбria' o Cliente nгo tem direito de se Creditar de ICMS ...

                        * Quando a Tipo de Negociaзгo = "Sem Negociaзгo", nunca podemos zerar essa variбvel 
                        $icms_item_current_rs porque senгo teremos problemas para calcular o valor_icms_st ...*/
                        /*if($situacao_tributaria == '60' && $tipo_negociacao != 'SN') {
                            $icms_item_current_rs = 0;
                        }else {*/
                            if($finalidade == 'C') {
                                $icms_item_current_rs = (($valor_total + $ipi_item_current_rs) * $icms / 100 * (100 - $reducao) / 100) + $icms_frete_despesas_acessorias_item_current_rs;
                            }else {
                                $icms_item_current_rs = ($valor_total * $icms / 100 * (100 - $reducao) / 100) + $icms_frete_despesas_acessorias_item_current_rs;
                            }
                        //}
                        /*Devido as novas leis de ST, entгo eu sу terei as Bases de Cбlculo  
                        1) Quando possuir iva em Sгo Paulo + somente com o PA de Op. Fat = 'Ind'
                        2) Quando possuir iva em qualquer outro Estado nгo importa a OF do PA ...*/
                        if($iva == 0 || ($iva > 0 && $operacao == 0 && $id_uf_cliente == 1) || ($iva > 0 && $id_uf_cliente > 1)) {
                            //Cбlculo com Reduзгo й em cima do Total dos Itens e do IPI dos Item ...
                            $base_calculo_icms_c_red = (($frete_despesas_acessorias_item_current_rs + $valor_total) * (100 - $reducao) / 100);
                            //Somente quando a Finalidade da NF for Igual а CONSUMO, que acrescenta o IPI do Frete R$ + IPI do Item em R$ ...
                            if($finalidade == 'C') $base_calculo_icms_c_red+= (($ipi_frete_despesas_acessorias_item_current_rs + $ipi_item_current_rs) * (100 - $reducao) / 100);
                        }
                        $base_calculo_icms_item_rs = $base_calculo_icms_c_red;
                   }else {
                        /**********Cуdigo Adaptado no dia 11/02/2014 - Dбrcio
                        Sempre que a Situaзгo do PA vs UF for = 60 'ICMS cobrado anteriormente por substituiзгo 
                        tributбria' o Cliente nгo tem direito de se Creditar de ICMS ...

                        * Quando a Tipo de Negociaзгo = "Sem Negociaзгo", nunca podemos zerar essa variбvel 
                        $icms_item_current_rs porque senгo teremos problemas para calcular o valor_icms_st ...*/
                        /*if($situacao_tributaria == '60' && $tipo_negociacao != 'SN') {
                            $icms_item_current_rs = 0;
                        }else {*/
                            if($finalidade == 'C') {
                                $icms_item_current_rs = (($valor_total + $ipi_item_current_rs) * $icms / 100 + $icms_frete_despesas_acessorias_item_current_rs);
                            }else {
                                $icms_item_current_rs = ($valor_total * $icms / 100 + $icms_frete_despesas_acessorias_item_current_rs);
                            }
                        //}

                        /*Devido as novas leis de ST, entгo eu sу terei as Bases de Cбlculo 
                        1) Quando nгo tiver o IVA 
                        2) Quando possuir iva em Sгo Paulo + somente com o PA de Op. Fat = 'Ind'
                        3) Quando possuir iva em qualquer outro Estado nгo importa a OF do PA ...*/
                        if($iva == 0 || ($iva > 0 && $operacao == 0 && $id_uf_cliente == 1) || ($iva > 0 && $id_uf_cliente > 1)) {
                            /*Aqui eu verifico a Classificaзгo Fiscal do Produto Corrente, se no caso for id_4 ou id_6 
                            que equivale a Classifaзгo Fiscal 82.07.90.00 ou 90.17.20.00, irб abastecer a variбvel 
                            $base_calculo_icms_bits_bedames_riscador ...*/
                            if($id_classific_fiscal == 4 || $id_classific_fiscal == 6) {//82.07.90.00 ou 90.17.20.00 ...
                                $base_calculo_icms_bits_bedames_riscador    = $valor_total + $frete_despesas_acessorias_item_current_rs + $ipi_frete_despesas_acessorias_item_current_rs + $ipi_item_current_rs;
                                $base_calculo_icms_item_rs                  = $base_calculo_icms_bits_bedames_riscador;
                                /*Esse desvio serб muito raro de acontecer, pois nгo serб mais feito uma Nota de Conserto 
                                junto com uma Nota Fiscal de Venda, sу aconteceu no inнcio p/ a Nota 4333 da Albafйr ...*/
                            }else if($id_classific_fiscal == 14) {//00.00.00.00 - Isento de Mгo de Obra ...
                                $isento+= $valor_total + $frete_despesas_acessorias_item_current_rs + $ipi_frete_despesas_acessorias_item_current_rs + $ipi_item_current_rs;
                            }else {//Outra Classificaзгo fiscal ...
                                $base_calculo_icms_s_red                    = $valor_total + $frete_despesas_acessorias_item_current_rs + $ipi_frete_despesas_acessorias_item_current_rs + $ipi_item_current_rs;
                                $base_calculo_icms_item_rs                  = $base_calculo_icms_s_red;
                            }
                        }
                    }
                    /***********************************************************************************************/
                    /***********************Atualizaзгo do ICMS а Creditar nas NF(s) de Saнda***********************/
                    /***********************************************************************************************/
                    /*Regras 

                    * 1) Se existir Valor de IVA em R$ ...
                    * 2) Somente p/ Empresa Alba ou Tool ...
                    * 3) NF(s) com Data de Emissгo >= 01/04/2009 que foi quando comeзou a vigorar a Nova Lei de ST ...
                    * 4) Operaзгo de Faturamento do PA = 'Revenda' 
                    * 5) Notas Fiscais = 'CONSUMO' / 'INDUSTRIALIZAЗГO' / 'REVENDA' mais que sejam diferentes de Sгo Paulo ...

                    Muito provбvel que este campo `icms_creditar_rs` sу seja utilizado no Relatуrio de Balanзo 
                    de Total de Impostos NFs vs NFe ...*/
                    if($tipo_negociacao == 'NF') {//Somente quando for Nota Fiscal que farб essa Rotina ...
                        if($iva > 0 && $nota_sgd == 'N' && $data_emissao >= '2009-04-01' && $operacao == 1 && ($finalidade == 'C' || $finalidade == 'I' || ($finalidade == 'R' && $id_uf_cliente > 1))) {
                            $sql = "UPDATE `nfs_itens` SET `icms_creditar_rs` = '$icms_item_current_rs' WHERE `id_nf` = '$id_negociacao' AND `id_produto_acabado` = '".$campos_itens[$i]['id_produto_acabado']."' LIMIT 1 ";
                            bancos::sql($sql);
                        }
                    }
                    /***********************************************************************************************/
                    /*************Sу existirб o cбlculo de Substituiзгo Tributбria (ST) se existir o IVA************/
                    /***********************************************************************************************/
                    if($tipo_negociacao == 'NFC') {//NF de Compras "Entrada" aqui o cбlculo й um pouco diferente ...
                        /*Porque quem emite a Nota Fiscal й o Fornecedor que pode ser Optante pelo Simples Nacional 
                        de outra UF e que exigem cбlculos particularizados incluindo atй uma Maracutaia que temos 
                        com a Contabilidade p/ se Creditar de Imposto ...*/
                        
                        /*Na NF de Compra a Base de Cбlculo de ICMS й calculada de outro modo, por isso que eu 
                        zero as variбveis $base_calculo_icms_c_red, $base_calculo_icms_s_red, 
                        $base_calculo_icms_bits_bedames_riscador ...*/
                        $base_calculo_icms_c_red                    = 0;
                        $base_calculo_icms_s_red                    = 0;
                        $base_calculo_icms_bits_bedames_riscador    = 0;
                        
                        if($optante_simples_nacional == 'S') {//Se for optante Simples Nacional ...
                            /*Verifica se o PI possui IVA, mas na minha visгo nгo precisarнamos fazer esse SQL devido 
                            termos o IVA jб gravado na Tabela de Itens de Nota Fiscal, talvez poderia dar erro exemplo: 
                            Nota Fiscal 288 "Intertaps" tem 52,19 de IVA e quando puxa do SQL nгo vem nada - 12/03/14 ...*/
                            $sql = "SELECT icms.iva 
                                    FROM `produtos_insumos` pi 
                                    INNER JOIN `icms` ON icms.`id_classific_fiscal` = pi.`id_classific_fiscal` AND icms.`id_uf` = '$id_uf_fornecedor' 
                                    WHERE pi.`id_produto_insumo` = '".$campos_itens[$i]['id_produto_insumo']."' LIMIT 1 ";
                            $campos_pi = bancos::sql($sql);
                            /*Se for Optante pelo Simples e existir IVA nгo temos valor de ICMS, importante lembrarmos 
                            isso porque essa variбvel estб sendo utilizada pelo $icms_item_current_oculto_creditar_rs ...*/
                            if($campos_pi[0]['iva'] > 0) $icms_item_current_rs = 0;
                        }
                        $icms_item_current_oculto_creditar_rs = $icms_item_current_rs;
                        
                        //Cбlculo do IVA sу existirб p/ "NFs" que sгo do Tipo NF mesmo e que possuem Valor de Iva ...
                        if($iva > 0 && $nota_sgd == 'N') {
                            /*Pode parecer uma redundвncia essa $icms_item_current_rs = 0, mas a situaзгo aqui й 
                            diferente porque agora essa variбvel й utilizada nos cбlculos de ST ... */
                            $icms_item_current_rs = 0;
                            //Verifica se o PA й um PI "PRAC" ...
                            $sql = "SELECT `id_produto_acabado` 
                                    FROM `produtos_acabados` 
                                    WHERE `id_produto_insumo` = '".$campos_itens[$i]['id_produto_insumo']."' 
                                    AND `id_produto_insumo` > '0' LIMIT 1 ";
                            $campos_pipa = bancos::sql($sql);
/*Se o PI for PRAC que й um PI de Revenda ou o PI for um Ajuste do Tipo Produto Acabado, 
entгo existe cбlculo p/ os campos de ST - Base ST e ICMS ST ...*/
                            if(count($campos_pipa) == 1 || ($campos_itens[$i]['id_produto_insumo'] == 1340 && $campos_itens[$i]['cod_tipo_ajuste'] == 5)) {//1340 й o id do PI que й Ajuste ...
                                //Nгo estamos levando em conta o Frete no cбlculo abaixo, porque atualmente o Frete й um PI ...
                                $base_calculo_icms_st_item_current_rs = ($valor_total + $ipi_item_current_rs) * (1 + $iva / 100);
                                if($optante_simples_nacional == 'S') {
                                    if($data_emissao <= '2009-07-31') {
                                        $abatimento_icms_st_para_simples = 7;//Sу existe p/ Simples Nacional ...
                                    }else {//A partir do mкs de agosto mudou a Regra com Relaзгo a esse Valor ...
                                        $abatimento_icms_st_para_simples = $icms;//Sу existe p/ Simples Nacional ...
                                    }
                                    $valor_icms_st_item_current_rs = $base_calculo_icms_st_item_current_rs * ($icms / 100) - ($abatimento_icms_st_para_simples / 100) * $valor_total;
                                }else {
                                    /*Estamos mantendo o icms_item_rs na fуrmula abaixo, pois caso o fornecedor seja 
                                    uma indъstria existirб esse ICMS, mesmo que o item possua IVA, 
                                    nos casos de Revenda o ICMS й Zerado ...*/
                                    $valor_icms_st_item_current_rs = $base_calculo_icms_st_item_current_rs * ($icms / 100) - $icms_item_current_rs;
                                }
                            }else {//Nгo й PRAC e nem Ajuste de "Produto Acabado", apenas PI ...
                                $valor_icms_oculto_creditar+= $icms_item_current_oculto_creditar_rs;//Esse ICMS oculto sу existirб quando o PI for PI mesmo ...
                                
                                $base_calculo_icms_st_item_current_rs   = 0;
                                $valor_icms_st_item_current_rs          = 0;
                            }
                            //Acumula o Total de Todas as variбveis referentes ao ST ...
                            $base_calculo_icms_st+= $base_calculo_icms_st_item_current_rs;
                            $valor_icms_st+= $valor_icms_st_item_current_rs;
                        }else {//Somente quando nгo existir o IVA ...
                            /*Obs: Tive que Criar essa variбvel $base_calculo_icms_em_compras especнfica sу p/ Compras, 
                            devido os cбlculos p/ essa Transaзгo serem diferentes ... 
                            Por enquanto й o Valor Total do Item, caso seja CONSUMO й necessбrio somar o IPI do Item 
                            em R$, sу existirб no caso de a NF for do Tipo NF mesmo ...*/
                            if($nota_sgd == 'N' && $icms > 0) {
                                if($finalidade == 'C') {//CONSUMO ...
                                    $base_calculo_icms_em_compras = $valor_total + $ipi_item_current_rs;
                                }else {
                                    $base_calculo_icms_em_compras = $valor_total;
                                }
                            }
                            /*****************Cбlculo para Reduзгo de Base de Cбlculo*****************/
                            $reducao_compras                = ($campos_itens[$i]['reducao'] > 0) ? $valor_total * ($campos_itens[$i]['reducao'] / 100) : 0;
                            $base_calculo_icms_em_compras-= $reducao_compras;
                            /*************************************************************************/
                            $base_calculo_icms_item_rs      = $base_calculo_icms_em_compras;
                        }
                    }else {//Esse calculo й o Padrгo independente do Tipo de Nota ...
                        /******************************************************************************/
                        /*Devido as novas leis de ST, entгo eu sу terei as Bases de Cбlculo 

                        1) Se existir Alнquota de IVA p/ o Item Corrente ...
                        2) Se o Cliente realmente quiser que seja tributado o IVA, pq hoje em dia muitos possuem 
                        uma "credencial" que isentam o Cliente de pagar esse Imposto ...
                        3) Quando a comercializaзгo sу for do Tipo NF mesmo "Alba ou Tool" ...
                        4) Quando for negociado REVENDA, p/ CONSUMO ou INDUSTRIALIZAЗГO nгo existe ...
                        5) Quando possuir iva em Sгo Paulo + somente com o PA de Op. Fat = 'Ind' ou Op. 'Rev' desde que sejam nas Origens de Mercadoria 1, 3, 5, 6 e 8 "em que somos Substitutos por industrializarmos ou nгo termos adquirido o Produto com Recolhimento de ST" ...
                        6) Quando possuir iva em qualquer outro Estado nгo importa a OF do PA ...*/
                        if($iva > 0 && $isento_st == 'N' && $nota_sgd == 'N' && $finalidade == 'R' && ($id_uf_cliente == 1 && ($operacao == 0 || $operacao == 1 && $campos_itens[$i]['origem_mercadoria'] == 1 || $campos_itens[$i]['origem_mercadoria'] == 3 || $campos_itens[$i]['origem_mercadoria'] == 5 || $campos_itens[$i]['origem_mercadoria'] == 6 || $campos_itens[$i]['origem_mercadoria'] == 8) || $id_uf_cliente > 1)) {
                            //Cбlculo do IVA - Base de Cбlculo ICMS ST por Item de NF ...
                            $vetor_dados_substituicao_tributaria = self::calculos_substituicao_tributaria($ipi_item_current_para_st_rs, $icms, $icms_intraestadual, $fecp, $iva, $valor_total, $icms_item_current_rs);
                            
                            //Acumula o Total de Todas as variбveis referentes ao ST ...
                            $base_calculo_icms_st+= $vetor_dados_substituicao_tributaria['base_calculo_icms_st_item_current_rs'];
                            $valor_icms_st+=        $vetor_dados_substituicao_tributaria['valor_icms_st_item_current_rs'];
                            
                            if($fecp > 0) {
                                $fecp_item              = $fecp;//Й a prуpria Alнquota FECP do Estado ...
                                $base_calculo_fecp_item = $vetor_dados_substituicao_tributaria['base_calculo_icms_st_item_current_rs'];
                                $valor_fecp_item        = number_format(round($base_calculo_fecp_item * ($fecp_item / 100), 2), 2, '.', '');

                                $valor_fecp+=           $valor_fecp_item;
                            }else {
                                $valor_fecp             = 0;
                            }
                        }
                    }
                    /***********************************************************************************************/
                    $base_calculo_icms+=    $base_calculo_icms_item_rs;
                    $valor_icms+=           $icms_item_current_rs;
                    /***********************************************************************************************/
                    /********************************************SUFRAMA********************************************/
                    /***********************************************************************************************/
                    if($desconto_pis_cofins_icms > 0) {
                        //O cбlculo de Desc. do Suframa c/ o Prу-Rata do Item sai + exato ...
                        $desconto+= (-1) * round(($qtde * $preco_unitario) * (($desconto_pis_cofins_icms) / 100), 2);
                    }
                    /***********************************************************************************************/
                    /*********************************************DIFAL*********************************************/
                    /***********************************************************************************************/
                    //Quando o Cliente nгo tiver Inscriзгo Estadual e este sempre fora de SP ...
                    if((empty($insc_estadual) || $insc_estadual == 0) && $id_uf_cliente > 1) {
                        $base_calculo_icms_uf_destino   = ($base_calculo_icms_item_rs * $campos_itens[$i]['icms_intraestadual'] / 100);
                        $base_calculo_icms_uf_remetente = ($base_calculo_icms_item_rs * $campos_itens[$i]['icms'] / 100);

                        $difal_item_current_rs          = $base_calculo_icms_uf_destino - $base_calculo_icms_uf_remetente;
                        $difal+= $difal_item_current_rs;

                        //Atй o ano passado 2017, a divisгo era de 60% e 40% ...
                        $valor_icms_destino_item_rs     = $difal_item_current_rs * 0.80;//O Cliente irб pagar 80% do ICMS ...
                        $valor_icms_remetente_item_rs   = $difal_item_current_rs * 0.20;//O Cliente irб pagar 20% do ICMS ...
                        
                        $valor_icms_destino+=           $valor_icms_destino_item_rs;
                        $valor_icms_remetente+=         $valor_icms_remetente_item_rs;
                    }
                }
                //Aqui eu arredondo os valores ...
                $base_calculo_icms                          = round($base_calculo_icms, 2);
                $valor_icms                                 = round($valor_icms, 2);
                $base_calculo_icms_st                       = round($base_calculo_icms_st, 2);
                $valor_icms_st                              = round($valor_icms_st, 2);
                $base_calculo_ipi                           = round($valor_total + $frete_despesas_acessorias_item_current_rs, 2);
                
                if($suframa > 0 || ($nota_sgd == 'S') || $id_pais != 31) {
                    $frete_ipi                          = 0;
                    $despesas_acessorias_ipi            = 0;
                }else {
                    $frete_ipi                          = ($valor_frete * ($ipi / 100));
                    $despesas_acessorias_ipi            = ($outras_despesas_acessorias * ($ipi / 100));
                }
                $valor_ipi          = $total_ipi_itens_rs + $ipi_frete_desp_aces_todos_itens;
                $valor_ipi_incluso  = $total_ipi_incluso_itens_rs / 2;//Essa divisгo por 2 й porque sу temos direito de creditar 50% quando o IPI й Incluso ...
                
                /*O Cбlculo de Isento deixei para fazer aqui embaixo porque precisava de algumas variбveis 
                que sу foram sendo abastecidas anteriormente no cуdigo ...*/
                if($finalidade == 'C') {//Nota Fiscal do Tipo CONSUMO ...
                    $isento = $valor_total_produtos + $valor_frete + $outras_despesas_acessorias + $valor_ipi - $base_calculo_icms;
                }else {//Revenda, nгo se acrescenta o Valor de IPI em R$ do Item no cбlculo do ICMS Corrente ...
                    //Lembrando que esse Isento й somente p/ os Itens que nгo sгo ST ...
                    $isento = $valor_total_produtos + $valor_frete + $outras_despesas_acessorias - $base_calculo_icms;
                }
                if((integer)$isento == '-0') $isento = 0;//Macete (rs) ...
                /********************************************************************************************/
                /********************Influenciarб na parte de Impressгo dos Textos da NF*********************/
                /********************************************************************************************/
                /*Se a NF for das Seguintes CFOP(s): 
                - 5.552 -> Transferкncia de Bens do Ativo Imobilizado
                - 5.901 -> Remessa p/ Industrializaзгo
                - 5.916 / 6.916 -> Retorno de Conserto
                - 5.913 / 6.913 -> Retorno de Demonstraзгo
                - 5.551 -> Venda de bem do Ativo Imobilizado
                - 5.908 -> Remessa em Comodato
                - 5.915 / 6.915 - Remessa p/ Conserto
                - 5.401 / 5.405 / 6.401 / 6.404 / 1.410 / 1.411 / 2.410 / 2.411 - NFs de Substituiзгo Tributбria ...
                - 5.914 -> Remessa p/ Exposiзгo
                - 1.914 -> Retorno de Exposiзгo
                entгo: */
                
                //Se a Empresa da Nota Fiscal for 'K2', nгo preciso fazer essa verificaзгo de CFOPS ...
                if($id_empresa_negociacao == 3) {//K2 ...
                    $vetor_cfops = array();
                }else {//Outras Empresas ...
                    //$vetor_cfops = array('5.552', '5.901', '5.916', '6.916', '5.913', '6.913', '5.551', '5.908', '5.915', '6.915', '5.914', '1.914');
                    $vetor_cfops = array('5.552', '5.901', '5.913', '6.913', '5.551', '5.908', '5.915', '6.915', '5.914', '1.914');
                }
                
                if(in_array($cfop, $vetor_cfops)) {
                    $isento     = $valor_total_produtos;
                    $valor_icms = 0;//ISENTO ...
                    //Casos Especiais p/ IPI ...
                    //1)//Quando a CFOP for "Venda de bem do Ativo Imobilizado", nгo existe IPI = ISENTO ...
                    //if($cfop != '5.551' && $cfop != '5.908') $valor_ipi = 'ISENTO';
                    //2)//Quando a CFOP for "Exposiзгo", IPI sempre serб = SUSPENSO ...
                    if($cfop == '1.914' || $cfop == '5.914') $valor_ipi = 0;//SUSPENSO ...
                    $base_calculo_icms = 0;
                    //5.949 -> Existem Trocentas ...
                }else if($cfop == '5.949') {
                    $inicio_natureza = strtoupper(strtok($natureza_operacao, ' '));
                    //Em outros tipos de NF em que a CFOP = "Remessa" ou = "Retorno" nгo existe Tributaзгo ...
                    if($inicio_natureza == 'REMESSA' || $inicio_natureza == 'RETORNO') {
                        $isento             = 0;
                        $valor_icms         = 0;//ISENTO ...
                        $valor_ipi          = 0;//ISENTO ...
                        $base_calculo_icms  = 0;
                    }
                }else if($cfop == '1.604') {//Crйdito Ativo Imobilizado ...
                    /*Busca o Valor do ICMS em cima do Texto que foi preenchido pelo usuбrio na parte de Texto de NF 
                    e este, serб apresentado no campo Valor do ICMS da NF ...*/
                    if(!empty($texto_nf)) {
                        $valor_icms = strstr($texto_nf, 'R$ ');
                        $valor_ipi  = strtok($valor_icms, 'ref');
                    }
                }
                /*Se a NF possui Suframa e este estб "Ativo" entгo: 
                1) Бrea de Livre Comйrcio IPI e ICMS de 7% (Se Suframa Ativo) ...
                2) Zona Franca de Manaus IPI, ICMS 7 % (Se Suframa Ativo) e (PIS+COFINS de 3,65% ...*/
                if(($suframa == 1 || $suframa == 2) && $suframa_ativo == 'S') {//Бrea de Livre Comйrcio ou Zona Franca de Manaus
                    //O valor de Isento fica igual ao Total da Mercadoria devido ter sido concedido o ICMS de 7% ...
                    $isento     = $valor_total_produtos;
                    $valor_icms = 0;//ISENTO ...
                    //Somente na Zona Franca "Suframa = 2" ... que eu zero as Bases de Cбlculo ...
                    if($suframa == 2) $base_calculo_icms = 0;
                }
                $valor_total_nota   = $valor_total_produtos + $valor_frete + $outras_despesas_acessorias + $valor_ipi + $valor_icms_st + $valor_fecp + $desconto;
            }
        }
        /*Sempre faзo esse arredondamento p/ nгo dar erro em outros locais do Sistema que fazem comparaзгo 
        com esse Valor retornado ...*/
        $valor_total_nota = round($valor_total_nota, 2);
        
        /*********************************************************************************************/
        /*******************************************Ajustes*******************************************/
        /*********************************************************************************************/
        /*Sу irб acrescentar ajuste nesses impostos abaixo quando a variбvel "$id_negociacao_item" = 0, porque isso 
        representa que o cбlculo foi feito em cima de todos os Itens da negociaзгo passada por parвmetro ...*/
        if($id_negociacao_item == 0) {
            $valor_icms+= $ajuste_valor_icms;
            $base_calculo_icms_st+= $ajuste_base_calc_icms_st;
            $valor_icms_st+= $ajuste_valor_icms_st;
        }
        /*********************************************************************************************/
        //Os 10 primeiros parвmetros que sгo retornados, sгo os campos que aparecem no Cбlculo do Impostos da Nota Fiscal ...
        return array('base_calculo_icms' => $base_calculo_icms, 'valor_icms' => $valor_icms, 'base_calculo_icms_st' => $base_calculo_icms_st, 'valor_icms_st' => $valor_icms_st, 'valor_total_produtos' => $valor_total_produtos, 'valor_frete' => $valor_frete, 'outras_despesas_acessorias' => $outras_despesas_acessorias, 'valor_ipi' => $valor_ipi, 'valor_total_nota' => $valor_total_nota, 'valor_total_nota_us' => $valor_total_nota_us, 'base_calculo_icms_c_red' => $base_calculo_icms_c_red, 'base_calculo_icms_s_red' => $base_calculo_icms_s_red, 'base_calculo_icms_bits_bedames_riscador' => $base_calculo_icms_bits_bedames_riscador, 'base_calculo_ipi' => $base_calculo_ipi, 'frete_despesas_acessorias' => $frete_despesas_acessorias_item_current_rs, 'ipi_frete_despesas_acessorias' => $ipi_frete_despesas_acessorias_txt, 'icms_frete_despesas_acessorias' => $icms_frete_despesas_acessorias_item_current_rs, 'imposto_importacao' => $ii_item_current_rs, 'iva_ajustado' => $vetor_dados_substituicao_tributaria['iva_ajustado'], 'peso_lote_total_kg' => $peso_lote_total_kg, 'desconto' => $desconto, 'valor_icms_oculto_creditar' => $valor_icms_oculto_creditar, 'valor_ipi_incluso' => $valor_ipi_incluso, 'difal' => $difal, 'valor_icms_destino' => $valor_icms_destino, 'valor_icms_remetente' => $valor_icms_remetente, 'fecp' => $fecp, 'valor_fecp' => $valor_fecp);
    }
    
    function calculos_substituicao_tributaria($ipi, $icms, $icms_intraestadual, $fecp, $iva, $valor_total, $valor_icms) {
        //Cбlculo do IVA - Base de Cбlculo ICMS ST Retido na Compra por Item de NF ...
        $iva_ajustado                           = ((1 + $iva / 100) * (1 - $icms / 100) / (1 - ($icms_intraestadual + $fecp) / 100)) - 1;
        $iva_ajustado                           = round($iva_ajustado, 4);
        $base_calculo_icms_st_item_current_rs 	= ($valor_total + $ipi) * (1 + $iva_ajustado);
        $valor_icms_st_item_current_rs 		= round(($base_calculo_icms_st_item_current_rs * $icms_intraestadual / 100) - $valor_icms, 2);
        
        return array('iva_ajustado' => $iva_ajustado, 'base_calculo_icms_st_item_current_rs' => $base_calculo_icms_st_item_current_rs, 'valor_icms_st_item_current_rs' => $valor_icms_st_item_current_rs);
    }

    function calculos_genericos() {
        /*Linha “Valor faturбvel” nгo existe .
        Fator Taxa financeira diбria  = ((1+tx.financ./100)^(1/30)
        Podemos calcular este valor como uma variбvel , atualizada toda vez que mudarmos a variбvel tx.financeira 30 dias .
        Fator Taxa financeira do pedido = fator tx.fin.diaria ^pz medio do pedido
        Fator SGD_UF=SP = (1-(%icms SP *(1-red SP /100)/100))*(1-imp.fed/100)
        Fator NF UF pedido = 1-(%icms UF pedido *(1-red UF pedido /100)/100)
        IF SGD 
        P.Fat.30/NF/SP = P.L.Final / Fator Taxa financeira do pedido * (1+tx.financ./100) / Fator SGD_UF=SP
        IF NF e UF = SP
        P.Fat.30/NF/SP = P.L.Final / Fator Taxa financeira do pedido * (1+tx.financ./100)
        IF NF e UF <> SP
        P.Fat.30/NF/SP = P.L.Final / Fator Taxa financeira do pedido * (1+tx.financ./100) * Fator NF UF pedido / Fator SGD_UF=SP*/
    }
}
?>